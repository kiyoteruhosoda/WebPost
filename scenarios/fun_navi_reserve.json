{
  "meta": {
    "id": 1,
    "name": "fun-navi-reserve",
    "description": "Fun Navi Login -> Reserve -> Extract reservation number (Test Scenario)",
    "version": 1,
    "enabled": true,
    "user_agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
  },
  "inputs": {
    "required": [
      "mansionGNo",
      "facilityID",
      "facilityNo",
      "selectDate",
      "toNo",
      "roomNo",
      "hiddenUserId",
      "dates"
    ],
    "optional": [
      "appliStart",
      "eventFlg",
      "eventFacilityNo",
      "rsvNo",
      "spEventFlg"
    ]
  },
  "defaults": {
    "http": {
      "base_url": "https://fun-navi.net",
      "timeout_sec": 20,
      "headers": {
        "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"
      }
    }
  },
  "steps": [
    {
      "id": "login_get",
      "type": "http",
      "enabled": true,
      "request": {
        "method": "GET",
        "url": "/FRPC010G_LoginAction.do",
        "headers": {}
      },
      "retry": { "max": 1, "backoff_sec": [1] },
      "on_error": [
        { "expr": null, "action": "abort" }
      ]
    },
    {
      "id": "scrape_login_hidden",
      "type": "scrape",
      "enabled": true,
      "command": "hidden_inputs",
      "save_as": "login_hidden",
      "on_error": [
        { "expr": null, "action": "abort" }
      ]
    },
    {
      "id": "login_post",
      "type": "http",
      "enabled": true,
      "request": {
        "method": "POST",
        "url": "/FRPC010G_LoginAction.do",
        "merge_from_vars": "login_hidden",
        "form_list": [
          ["screenID", "FRPC010G"],
          ["referrer", ""],
          ["fulltimeID", "${secrets.FUNNAVI_FULLTIME_ID}"],
          ["password", "${secrets.FUNNAVI_PASSWORD}"],
          ["loginBTN", "ログイン"]
        ]
      },
      "retry": { "max": 1, "backoff_sec": [1] },
      "on_error": [
        { "expr": "${last.status}>=500", "action": "retry" },
        { "expr": null, "action": "abort" }
      ]
    },
    {
      "id": "assert_login_success",
      "type": "assert",
      "enabled": true,
      "conditions": [
        { "expr": "${last.status}==200" }
      ],
      "on_error": [
        { "expr": null, "action": "abort" }
      ]
    },
    {
      "id": "reserve_post",
      "type": "http",
      "enabled": true,
      "request": {
        "method": "POST",
        "url": "/FRPC0400G_RegAction.do",
        "form_list": [
          ["screenID", "FRPC0400G"],
          ["mansionGNo", "${vars.mansionGNo}"],
          ["facilityID", "${vars.facilityID}"],
          ["facilityNo", "${vars.facilityNo}"],
          ["appliStart", "${vars.appliStart}"],
          ["eventFlg", "${vars.eventFlg}"],
          ["eventFacilityNo", "${vars.eventFacilityNo}"],
          ["rsvNo", "${vars.rsvNo}"],
          ["spEventFlg", "${vars.spEventFlg}"],
          ["selectDate", "${vars.selectDate}"],
          ["toNo", "${vars.toNo}"],
          ["roomNo", "${vars.roomNo}"],
          ["date", ""],
          ["date", "${vars.dates[*]}"],
          ["hiddenUserId", "${vars.hiddenUserId}"]
        ]
      },
      "retry": { "max": 2, "backoff_sec": [1, 3] },
      "on_error": [
        { "expr": "${last.status}==401", "action": "goto", "goto_step_id": "login_get" },
        { "expr": "${last.status}>=500", "action": "retry" },
        { "expr": null, "action": "abort" }
      ]
    },
    {
      "id": "extract_reservation_no",
      "type": "scrape",
      "enabled": true,
      "command": "label_next_td",
      "label": "予約番号",
      "save_as": "reservationNo",
      "on_error": [
        { "expr": null, "action": "abort" }
      ]
    },
    {
      "id": "assert_reservation_no",
      "type": "assert",
      "enabled": true,
      "conditions": [
        { "expr": "${last.status}==200" },
        { "expr": "matches(${vars.reservationNo}, '^[0-9]{11}$')" }
      ],
      "on_error": [
        { "expr": null, "action": "abort" }
      ]
    },
    {
      "id": "result",
      "type": "result",
      "enabled": true,
      "fields": {
        "reservationNo": "${vars.reservationNo}"
      }
    }
  ]
}
